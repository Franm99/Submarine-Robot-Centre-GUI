<!-- 
    Fran Moreno - 04/2021
    Latest version can be found in:
    https://github.com/Franm99/Submarine-Robot-Centre-GUI.git
-->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8"/>
    <title>TELEROBOT VERSION 3.0 1/4/2021</title>
    <!-- <link rel="stylesheet" href="styles.css"> -->

    <style>
    h2   {
        font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        color: rgb(49, 125, 125);
    }

    p    {
        font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    button {
        background-color: rgb(49, 100, 125);
        color:seashell;
        width: 65px;
        height: 65px;
        text-align: center;
        border: none;
        margin-bottom: 5px;
        font-size: 17px;
        border-radius: 30%;
    }

    .button2 {
        width: 100px;
        height: 35px;
        padding: 10px;
        font-size: medium;
        border-radius: 0%;
        display: inline-block;
        margin:"0";
        cursor: pointer;
    }

    .button2:hover {
        background-color: darkgray;
    }

    .btn-row button {
        background-color: rgb(49, 100, 125);
        border: none;
        color: white;
        padding: 10px 24px;
        cursor: pointer;
        float: none;
    }

    .btn-row button:not(:last-child) {
        border-right: none;
    }

    .btn-row:after {
        content: "";
        clear: both;
        display: table;
    }

    .btn-row button:hover {
        background-color: darkgray;
    }

    .column {
        background-color: gainsboro;
        border:black;
        border-width: 2px;
        /* border-color: black; */
        float: left;
        width: 300px;
        padding: 10px;
        height: 520px;
    }

    .column2 {
        background-color: gainsboro;
        float: left;
        width:auto;
        padding: 10px;
        width: auto;
        height: 520px;
    }

    .minicolumn {
        background-color: gainsboro;
        float: left;
        width: 140px;
        padding: 2px;
        height: 115px;
    }

    .row:after {
        content: "";
        display: table;
        clear: both;
    }

    .modal {
        display: none;   /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1;      /* Sit on top */
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;  /* Enable scroll if needed */
        background-color: black;
        background-color: rgba(0,0,0,0.4);
    }

    .modal-content {
        background-color: rgb(255, 255, 255, 0.7);
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        height: auto;
    }

    .modal-body {
        overflow-y: auto;
    }

    .code {
        background: rgba(0,0,0,0.6);
        padding: 10px;
        color: white;
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }

    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }

    .col-3 {
        display: inline-block;
        padding: 2px;
        cursor:pointer;
        margin-right: 15px;   
        /* font-weight: bold; */
    }

    .flexbox-container {
        display: flex;
        justify-content: space-between;
        flex-flow: row nowrap;
    }

    .myLabel {
        width: 40px;
        display: inline-block;
    }

    .myForm {
        size: "8";
    }

    ul {
        font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    label {
        font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    </style>

    <!-- Script for jQuery -->
    <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script> -->
    <script src="src/jquery-3.6.0.js"></script>

</head>


<body style="background-color: beige;">
    <!-- <img src="src/logo.jpg" alt="Logo"> -->
    <div>
        <div class="col-3" style="color: rgb(49, 100, 125);font-weight: bold;">
            <p class="mySel" id="g5001_sel" onclick="setTarget('g5001')">Girona 500 1</p>
        </div>
        <div class="col-3">
            <p class="mySel" id="g5002_sel" onclick="setTarget('g5002')">Girona 500 2</p>
        </div>
        <div class="col-3">
            <p class="mySel" id="brov_sel" onclick="setTarget('brov')">BlueROV</p>
        </div>
        <div class="col-3">
            <p class "mySel" id="info_sel">Help</p>
        </div>
    </div>

    <div class="row">

        <div class="column2">
            <div>
                <iframe id="img" src="http:127.0.0.1:8001" title="Gir5001 image" width="640" height="480"></iframe>
            </div>
            <div>
                <p style="text-align: center; background-color: rgb(49, 100, 125, 0.4); 
                font-size: 14px; font-weight: bold;" id="dir"></p>
            </div>
        </div>
        <div class="column">

            <!-- controls  -->
            <hr>
            <div class="btn-row" style="text-align: center;">
                <button id="up"       onclick="up()"        >&#9039</button>
                <button id="forward"  onclick="forward()"   >&#8593</button>
                <button id="down"     onclick="down()"      >&#9046</button>
                <button style="margin-left: 20px;" id="openG" onclick="openG()">O</button>
            </div>
            <div class="btn-row" style="text-align: center;">
                <button id="left"     onclick="left()"      >&#8592</button>
                <button id="stop"     onclick="stop()"      >&#9632</button>
                <button id="right"    onclick="right()"     >&#8594</button>
                <button style="margin-left: 20px;" id="stopG" onclick="stopG()">S</button>
            </div>
            <div class="btn-row" style="text-align: center;">
                <button id="turnright" onclick="turnright()" >&#8635</button>
                <button id="backward"  onclick="backward()"  >&#8595</button>
                <button id="turnleft"  onclick="turnleft()"  >&#8634</button>
                <button style="margin-left: 20px;" id="closeG" onclick="closeG()">C</button>
            </div>
            <hr>
            <div class="row">
                <div class="minicolumn">
                    <form>
                        <label class="myLabel">X: </label>
                        <input size="8" type="text" name="X" value="0.0"/><br>
                        <label class="myLabel">Y: </label>
                        <input size="8"type="text" name="Y" value="0.0"/><br>
                        <label class="myLabel">Z: </label>
                        <input size="8" type="text" name="Z" value="0.0"/><br>
                        <label class="myLabel">AZ: </label>
                        <input size="8" type="text" name="AZ" value="0.0"/><br>
                        <label class="myLabel">%: </label>
                        <input size="8" type="text" name="PERCENTAGE" value="100"/>
                        <!-- <button class=button2 type="submit" id="collect" onclick="collect_params()">Set Velocity</button> -->
                    </form>
                </div>
                <div class="minicolumn">
                    <!-- <p style="text-align: center;">(Format: 0.0) </p> -->
                    <!-- <br><br><br><br> -->
                    <button class=button2 style="width: 100%;height:auto" id="collect" onclick="collect_params()">Set Velocity</button>
                </div>
                <p id="result"></p>
            </div>
            <hr>

            <div>
                <!-- <a href="http://localhost:8000/getPosition">Get Position</a> -->
                <!-- <button class=button2 id="getPos" onclick="getPosition()">Get Position</button> -->
                <form id="getPosForm" target="popup" style="text-align: center;">
                    <button class=button2 id=getPos type="submit" value="Get Position"
                    style="width: 100%;" onclick="getPosition()">Get Position</button>
                </form>
            </div>
            <div>
                <button class="button2" onclick="refreshIFrame()" 
                style="text-align: center; width: 100%;" >Get Robot Camera</button>
            </div>
            <hr>
        </div>
    </div>

    <!-- Pop-up help window -->
    <div id="info" class="modal">
        <!-- Info content -->
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 style="text-align: center;">TELEROBOT VERSION 3.0 1/4/2021</h2>
            <p>Run the TWINBOT Robotic Center Simulator before start using this GUI.</p>
            <ul>
                <li>Select the target to manage: Girona 500 1, Girona 500 2 or BlueROV.</li>
                <li>Each button will activate a control command. Last command sent wil be displayed in a text box below the picture.</li>
                <li>Manual control buttons allow horizontal and vertical displacements, rotating about the Z (vertical) axis and stop moving.
                    <em>O</em>, <em>S</em> and <em>C</em> buttons refer to <em>Open</em>, <em>Stop</em> and <em>Close</em> griper, respectively.
                </li>
                <li>To obtain the current camera image, press the <em>Get Robot Camera</em> button.</li>
                <li>To obtain the current robot position, press the <em>Get Position</em> button. Coordinates will be displayed in a pop-up window 
                under JSON format.</li>
                <li>The <em>Set Velocity</em> fields must be expressed with dot format decimal numbers. <em>AZ</em> refers to Z-axis rotation, and
                <em>%</em> refers to velocity percentage. </li>
            </ul>
        </div>

    </div>

    <!-- My scripts -->
    <!-- <script src="control.js"></script> -->
    <script>
        
    // Path variables //
    var base_url = "http://127.0.0.1:"
    var g5001  = {base: "8000", cam: "8001", gripper: "8002"};
    var g5002  = {base: "8010", cam: "8011", gripper: "8012"};
    var brov   = {base: "8020", cam: "8021"};  // No gripper
    var m_comm = {stop: "/stop",
                fw  : "/forward",
                bw  : "/backward",
                l   : "/left",
                r   : "/right",
                u   : "/up",
                d   : "/down",
                tl  : "/turnleft",
                tr  : "/turnright",
                setV: "/setVelocity?",
                getP: "/getPosition"
                };
    var g_comm = {stop : "/STOP",
                open : "/OPEN",
                close: "/CLOSE"
                };

    target = "g5001";

    var velPctg = 100.0;
    var velFraction = 1.0;

    document.getElementById("dir").innerHTML = base_url + eval(target).base;

    function get_pctg() {
    velPctg = document.getElementById("vel_pctg").value;
    velFraction = velPctg / 100.0;
    document.getElementById("pctg_label").innerHTML = velPctg + " %";
    // console.log('Vel percentage: ' + velFraction);
    }

    // Button functions //
    function up(){
        var dir = base_url + eval(target).base + m_comm.u;
        fetch(dir, {mode:'no-cors'});
        showLastComm(dir);
    }

    function down(){
        var dir = base_url + eval(target).base + m_comm.d;
        fetch(dir, {mode:'no-cors'});
        showLastComm(dir);
    }

    function left(){
        var dir = base_url + eval(target).base + m_comm.l;
        fetch(dir, {mode:'no-cors'});
        showLastComm(dir);
    }

    function right(){
        var dir = base_url + eval(target).base + m_comm.r;
        fetch(dir, {mode:'no-cors'});
        showLastComm(dir);
    }

    function forward(){
        var dir = base_url + eval(target).base + m_comm.fw;
        fetch(dir, {mode:'no-cors'});
        showLastComm(dir);
    }

    function backward(){
        var dir = base_url + eval(target).base + m_comm.bw;
        fetch(dir, {mode:'no-cors'});
        showLastComm(dir);
    }

    function turnleft(){
        var dir = base_url + eval(target).base + m_comm.tl;
        fetch(dir, {mode:'no-cors'});
        showLastComm(dir);
    }

    function turnright(){
        var dir = base_url + eval(target).base + m_comm.tr;
        fetch(dir, {mode:'no-cors'});
        showLastComm(dir);
    }

    function stop(){
        var dir = base_url + eval(target).base + m_comm.stop;
        fetch(dir, {mode:'no-cors'});
        showLastComm(dir);
    }

    function openG(){
        var dir = base_url + eval(target).gripper + g_comm.open;
        fetch(dir, {mode:'no-cors'});
        showLastComm(dir);
    }

    function stopG() {
        var dir = base_url + eval(target).gripper + g_comm.stop;
        fetch(dir, {mode:'no-cors'});
        showLastComm(dir);
    }

    function closeG() {
        var dir = base_url + eval(target).gripper + g_comm.close;
        fetch(dir, {mode:'no-cors'});
        showLastComm(dir);
    }

    function setVelocity(queue) {
        var dir = base_url + eval(target).base + m_comm.setV + queue;
        var xmlHttp = new XMLHttpRequest();
        xmlHttp.addEventListener("load", function(){});
        xmlHttp.open("GET", dir);
        xmlHttp.send(null);
        showLastComm(dir);
    }

    function getPosition() {
        var dir = base_url + eval(target).base + m_comm.getP;
        showLastComm(dir);
        document.getElementById("getPosForm").action = dir;
        window.open(dir, 'popup', 'left=500,top=500,width=550,height=20,scrollbars=no,resizable=no');
    }

    // Image showing
    function refreshIFrame() {
        var ifr = document.getElementById("img");
        dir = base_url + eval(target).cam;
        ifr.src = dir;
        showLastComm(dir);
    }

    function collect_params() {
        var queue = $('form').serialize();
        queue = queue.replace(/\./g, ",");
        setVelocity(queue);
    }

    function setTarget(tgt) {
        target = tgt;
        var all = document.getElementsByClassName("col-3");
        for (var i = 0; i < all.length; i++) {
            all[i].style.color = "black";
            all[i].style.fontWeight = "normal";
        }

        var act;
        if (tgt == "g5001")
            act = 0;
        else if (tgt == "g5002")
            act = 1;
        else 
            act = 2;

        document.getElementsByClassName("col-3")[act].style.color = "rgb(49, 100, 125)";
        document.getElementsByClassName("col-3")[act].style.fontWeight = "bold";
        
        dir = base_url + eval(target).base;
        showLastComm(dir);
    }

    function showLastComm(dir) {
        document.getElementById("dir").innerHTML = dir;
    }


    // -  Some help  - // 
    // Get the modal
    var info = document.getElementById("info");

    // Get the button that opens the modal
    var btn = document.getElementById("info_sel");

    // Get the <span> element that closes the modal
    var span = document.getElementsByClassName("close")[0];

    // When the user clicks the info image, open the modal
    btn.onclick = function() {
        info.style.display = "block";
    }

    // When the user clicks on <span> (x), close the modal
    span.onclick = function() {
        info.style.display = "none";
    }

    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function(event) {
        if (event.target == info) {
            info.style.display = "none";
        }
    }

    </script>

</body>
